<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOTTORI CLOUD ARCHIVE</title>
    <link href="https://cdn.jsdelivr.net/gh/sun-typeface/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --paper: #D1D3D3; --ink: #1a1a1a; --border: #A0A2A2; --font-serif: "Times New Roman", "serif"; --card-inner-bg: rgba(255, 255, 255, 0.15); --accent: #4A565C; }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background-color: var(--paper); background-image: url("https://www.transparenttextures.com/patterns/asfalt-dark.png"); color: var(--ink); line-height: 1.6; padding-bottom: 140px; word-break: keep-all; -webkit-tap-highlight-color: transparent; }
        header { padding: 40px 20px 20px; max-width: 600px; margin: 0 auto; text-align: center; cursor: pointer; }
        header h1 { font-size: 11px; letter-spacing: 0.3em; margin-bottom: 10px; opacity: 0.6; }
        .main-title { font-size: 42px; font-family: var(--font-serif); border-bottom: 2px solid var(--ink); display: inline-block; line-height: 1.1; }
        .sub-title { font-size: 24px; font-weight: 300; display: block; margin-top: 5px; opacity: 0.8; }
        nav { position: fixed; bottom: 20px; left: 0; right: 0; width: 100%; display: flex; justify-content: center; z-index: 1000; }
        .nav-inner { display: flex; gap: 4px; background: rgba(20, 20, 20, 0.9); padding: 8px 12px; border-radius: 40px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); width: 90%; overflow-x: auto; scrollbar-width: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .nav-inner::-webkit-scrollbar { display: none; }
        .nav-inner a { text-decoration: none; font-size: 10px; color: #888; padding: 10px 14px; border-radius: 30px; font-weight: 800; transition: 0.2s; white-space: nowrap; flex-shrink: 0; }
        .nav-inner a.active { background: #fff; color: #000; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        .content-section { display: none; animation: fadeIn 0.4s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 11px; letter-spacing: 0.15em; margin: 35px 0 15px; font-weight: 800; color: #333; opacity: 0.8; }
        .card { border: 1px solid var(--border); padding: 2px; margin-bottom: 15px; background: transparent; }
        .card-inner { border: 1px solid var(--border); padding: 16px; background: var(--card-inner-bg); position: relative; }
        .check-item { display: flex; align-items: flex-start; gap: 10px; cursor: pointer; margin-bottom: 10px; min-height: 32px; }
        .check-item input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 1px solid var(--ink); background: transparent; cursor: pointer; flex-shrink: 0; position: relative; }
        .check-item input[type="checkbox"]:checked { background: var(--ink); }
        .check-item input[type="checkbox"]:checked::after { content: 'âœ“'; color: white; position: absolute; font-size: 14px; left: 4px; top: -2px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.5); margin-bottom: 8px; font-family: inherit; font-size: 14px; box-sizing: border-box; border-radius: 0; }
        .btn-black { background: var(--ink); color: #fff; border: none; padding: 15px; width: 100%; cursor: pointer; font-size: 11px; font-weight: 700; letter-spacing: 0.1em; }
        .btn-del { color: #888; font-size: 11px; cursor: pointer; float: right; padding: 5px; }
        .img-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
        .img-scroll img { width: 85px; height: 85px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
        .monitor { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .monitor-item { border: 1px solid var(--border); background: var(--card-inner-bg); padding: 12px 4px; text-align: center; font-size: 9px; }
        .monitor-item b { display: block; font-size: 13px; margin-top: 4px; color: #000; }
        details summary { cursor: pointer; font-size: 12px; font-weight: bold; padding: 12px; background: rgba(0,0,0,0.05); margin-bottom: 8px; border: 1px solid var(--border); }
    </style>
</head>
<body>

<header onclick="showTab('home')">
    <h1>TOTTORI ARCHIVE</h1>
    <span class="main-title">ç¶´ã‚‹</span>
    <span class="sub-title">å‡ºæ¥äº‹</span>
</header>

<nav>
    <div class="nav-inner">
        <a href="javascript:void(0)" onclick="showTab('home')" id="btn-home" class="active">HOME</a>
        <a href="javascript:void(0)" onclick="showTab('prep')" id="btn-prep">PREP</a>
        <a href="javascript:void(0)" onclick="showTab('plan')" id="btn-plan">PLAN</a>
        <a href="javascript:void(0)" onclick="showTab('drive')" id="btn-drive">DRIVE</a>
        <a href="javascript:void(0)" onclick="showTab('pay')" id="btn-pay">PAY</a>
        <a href="javascript:void(0)" onclick="showTab('diary')" id="btn-diary">DIARY</a>
        <a href="javascript:void(0)" onclick="showTab('link')" id="btn-link">LINK</a>
    </div>
</nav>

<div class="container">
    <section id="tab-home" class="content-section active">
        <div class="card"><div class="card-inner">
            <p style="font-size:15px; line-height: 1.8; font-family: var(--font-serif); text-align: center; margin: 10px 0;">"ì‚¬êµ¬ì—ì„œì˜ ë°”ëŒê³¼,<br>ë°”ë‹¤ì˜ ì†Œë¦¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•©ë‹ˆë‹¤."</p>
        </div></div>
        <div class="section-title">Settings (Cloud)</div>
        <div class="card"><div class="card-inner">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="text" id="nameA" placeholder="ì¸ì› A ì´ë¦„">
                <input type="text" id="nameB" placeholder="ì¸ì› B ì´ë¦„">
            </div>
            <button onclick="updateNames()" class="btn-black">ì¸ì› ì •ë³´ ì—…ë°ì´íŠ¸</button>
        </div></div>
    </section>

    <section id="tab-prep" class="content-section">
        <div class="section-title">Checklist</div>
        <div class="card"><div class="card-inner" id="fixedPrep" style="display:grid; grid-template-columns:1fr 1fr; gap:2px;"></div></div>
        <input type="text" id="prepIn" placeholder="ì¶”ê°€ í•­ëª©">
        <button onclick="addItem('prep')" class="btn-black">ADD ITEM</button>
        <div id="customPrepList" style="margin-top:10px;"></div>
    </section>

    <section id="tab-plan" class="content-section">
        <div class="section-title">Recommendations</div>
        <details><summary>ì¶”ì²œ ì¥ì†Œ í”„ë¦¬ì…‹ ë³´ê¸°</summary><div id="presetList" class="card" style="background: white;"></div></details>
        <div id="planList"></div>
        <div class="section-title">Add Schedule</div>
        <div class="card"><div class="card-inner">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <select id="planDay"><option value="1">DAY 1</option><option value="2">DAY 2</option><option value="3">DAY 3</option></select>
                <input type="time" id="planTime">
            </div>
            <input type="text" id="planTitle" placeholder="ì¥ì†Œëª…">
            <textarea id="planMemo" placeholder="ë©”ëª¨" rows="2"></textarea>
            <button onclick="addItem('plan')" class="btn-black">SAVE PLAN</button>
        </div></div>
    </section>

    <section id="tab-drive" class="content-section">
        <div class="section-title">Driving Principles</div>
        <div class="card"><div class="card-inner" id="principlesUI"></div></div>
    </section>

    <section id="tab-pay" class="content-section">
        <div class="monitor">
            <div class="monitor-item">ê³µê¸ˆ ì”ì•¡<b id="b-p">Â¥0</b></div>
            <div class="monitor-item"><span class="label-a">A</span> ì”ì•¡<b id="b-a">Â¥0</b></div>
            <div class="monitor-item"><span class="label-b">B</span> ì”ì•¡<b id="b-b">Â¥0</b></div>
        </div>
        <div id="payList"></div>
        <div class="card"><div class="card-inner">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:8px;">
                <input type="number" id="bud-p" placeholder="ê³µê¸ˆ">
                <input type="number" id="bud-a" class="ph-a" placeholder="A ì˜ˆì‚°">
                <input type="number" id="bud-b" class="ph-b" placeholder="B ì˜ˆì‚°">
            </div>
            <button onclick="updateBud()" class="btn-black" style="background:#666; padding:10px; margin-bottom:10px;">SET BUDGET</button>
            <select id="payTarget"><option value="p">ê³µê¸ˆ</option><option value="a" class="opt-a">A ì‚¬ë¹„</option><option value="b" class="opt-b">B ì‚¬ë¹„</option></select>
            <input type="text" id="payName" placeholder="ë‚´ì—­">
            <input type="number" id="payAmt" placeholder="ê¸ˆì•¡(Â¥)">
            <input type="file" id="payFile" multiple style="font-size: 11px;">
            <button onclick="addItem('pay')" class="btn-black">SAVE PAY</button>
        </div></div>
    </section>

    <section id="tab-diary" class="content-section">
        <div id="diaryList"></div>
        <div class="card"><div class="card-inner">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <select id="diaryDay"><option value="1">DAY 1</option><option value="2">DAY 2</option><option value="3">DAY 3</option></select>
                <select id="diaryWeather"><option value="â˜€ï¸">ë§‘ìŒ</option><option value="â˜ï¸">íë¦¼</option><option value="â˜”">ë¹„</option></select>
            </div>
            <select id="diaryUser"><option value="">ì‘ì„±ì ì„ íƒ</option><option value="a" class="opt-a">A</option><option value="b" class="opt-b">B</option></select>
            <textarea id="diaryText" placeholder="ì˜¤ëŠ˜ì˜ ì¶”ì–µ..." rows="4"></textarea>
            <input type="file" id="diaryFile" multiple style="font-size: 11px;">
            <button onclick="addItem('diary')" class="btn-black">SAVE DIARY</button>
        </div></div>
    </section>

    <section id="tab-link" class="content-section">
        <div class="section-title">Essential Links</div>
        <div id="fixedLinks"></div>
        <div id="customLinks"></div>
        <div class="card"><div class="card-inner">
            <input type="text" id="linkName" placeholder="ì‚¬ì´íŠ¸ëª…">
            <input type="text" id="linkUrl" placeholder="URL">
            <button onclick="addItem('link')" class="btn-black">ADD LINK</button>
        </div></div>
    </section>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âœ… ì‚¬ìš©ìê°€ ì œê³µí•œ Firebase ì„¤ì •ê°’ ì‚½ì… ì™„ë£Œ
    const firebaseConfig = {
        apiKey: "AIzaSyDqb3T4kmMH5WVNFsXIUiSjlasqWmPy-gs",
        authDomain: "tottori-b87de.firebaseapp.com",
        projectId: "tottori-b87de",
        storageBucket: "tottori-b87de.firebasestorage.app",
        messagingSenderId: "623777703084",
        appId: "1:623777703084:web:23bb589da2e3cea36e2b09",
        measurementId: "G-YWTTNW5766"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ê¸°ë³¸ ë°ì´í„° ì •ì˜
    const PRESET_PREP = ["ì—¬ê¶Œ/ë©´í—ˆì¦", "í•œêµ­ë©´í—ˆì¦", "ë¹„ì§“ì¬íŒ¬QR", "ì—”í™” í˜„ê¸ˆ", "110V ë¼ì§€ì½”", "ë³´ì¡°ë°°í„°ë¦¬", "ìœ ì‹¬/ì´ì‹¬", "ë¹„ìƒì•½", "ë™ì „ì§€ê°‘"];
    const PRESET_PLACES = [{n: "ë—í† ë¦¬ ì‚¬êµ¬", m: "í•´ì•ˆ ì‚¬êµ¬"}, {n: "ì½”ë‚œ ë°•ë¬¼ê´€", m: "ì•„ì˜¤ì•¼ë§ˆ ê³ ì‡¼"}];
    const DRIVE_P = [{e:"ğŸ›‘",b:"æ­¢ã¾ã‚Œ",s:"ì •ì§€ì„  3ì´ˆ ì •ì§€"}, {e:"â¬…ï¸",b:"ì¢Œì¸¡í†µí–‰",s:"ë°˜ëŒ€ ë°©í–¥ ì£¼ì˜"}];

    window.appState = { customPrep: [], plan: [], pay: [], diary: [], links: [], buds: {p:0, a:0, b:0}, names: {a: "ì¸ì›A", b: "ì¸ì›B"} };

    // ì‹¤ì‹œê°„ ìˆ˜ì‹  ì„¤ì •
    onSnapshot(doc(db, "settings", "global"), (s) => { if(s.exists()) { window.appState.names = s.data().names; window.appState.buds = s.data().buds || {p:0, a:0, b:0}; render(); } });
    onSnapshot(collection(db, "prep"), (s) => { window.appState.customPrep = s.docs.map(d=>({id:d.id, ...d.data()})); render(); });
    onSnapshot(collection(db, "plan"), (s) => { window.appState.plan = s.docs.map(d=>({id:d.id, ...d.data()})); render(); });
    onSnapshot(collection(db, "pay"), (s) => { window.appState.pay = s.docs.map(d=>({id:d.id, ...d.data()})); render(); });
    onSnapshot(collection(db, "diary"), (s) => { window.appState.diary = s.docs.map(d=>({id:d.id, ...d.data()})); render(); });
    onSnapshot(collection(db, "links"), (s) => { window.appState.links = s.docs.map(d=>({id:d.id, ...d.data()})); render(); });

    // ì „ì—­ í•¨ìˆ˜
    window.showTab = (id) => {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-inner a').forEach(a => a.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.getElementById('btn-'+id).classList.add('active');
        window.scrollTo(0,0);
    };

    window.updateNames = async () => {
        const a = document.getElementById('nameA').value || "ì¸ì›A";
        const b = document.getElementById('nameB').value || "ì¸ì›B";
        await setDoc(doc(db, "settings", "global"), { names: { a, b } }, { merge: true });
        alert("ì´ë¦„ ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
    };

    window.updateBud = async () => {
        const buds = { p: Number(document.getElementById('bud-p').value), a: Number(document.getElementById('bud-a').value), b: Number(document.getElementById('bud-b').value) };
        await setDoc(doc(db, "settings", "global"), { buds }, { merge: true });
        alert("ì˜ˆì‚° ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
    };

    async function getBase64(input) {
        if (!input.files || input.files.length === 0) return [];
        return Promise.all(Array.from(input.files).map(f => new Promise(res => {
            const r = new FileReader(); r.onload = e => res(e.target.result); r.readAsDataURL(f);
        })));
    }

    window.addItem = async (type) => {
        if(type==='prep') {
            const text = document.getElementById('prepIn').value;
            if(text) await addDoc(collection(db, "prep"), { text });
        } else if(type==='plan') {
            const title = document.getElementById('planTitle').value;
            if(title) await addDoc(collection(db, "plan"), { day: document.getElementById('planDay').value, time: document.getElementById('planTime').value, title, memo: document.getElementById('planMemo').value });
        } else if(type==='pay') {
            const imgs = await getBase64(document.getElementById('payFile'));
            await addDoc(collection(db, "pay"), { target: document.getElementById('payTarget').value, name: document.getElementById('payName').value, amt: Number(document.getElementById('payAmt').value), imgs, createdAt: Date.now() });
        } else if(type==='diary') {
            const u = document.getElementById('diaryUser').value;
            if(!u) return alert("ì‘ì„±ì ì„ íƒ!");
            const imgs = await getBase64(document.getElementById('diaryFile'));
            await addDoc(collection(db, "diary"), { day: document.getElementById('diaryDay').value, weather: document.getElementById('diaryWeather').value, user: window.appState.names[u], text: document.getElementById('diaryText').value, imgs, comments: [], createdAt: Date.now() });
        } else if(type==='link') {
            const h = document.getElementById('linkName').value;
            const u = document.getElementById('linkUrl').value;
            if(h && u) await addDoc(collection(db, "links"), { h, u: u.startsWith('http')?u:'https://'+u });
        }
        document.querySelectorAll(`#tab-${type} input:not([type="checkbox"]), #tab-${type} textarea`).forEach(el => el.value = '');
    };

    window.addComment = async (id) => {
        const input = document.getElementById(`cmt-in-${id}`);
        if(input.value) {
            await updateDoc(doc(db, "diary", id), { comments: arrayUnion(input.value) });
            input.value = '';
        }
    };

    window.delItem = async (type, id) => { if(confirm("ì‚­ì œ?")) await deleteDoc(doc(db, type, id)); };

    function render() {
        const s = window.appState; const n = s.names;
        document.querySelectorAll('.label-a, .opt-a').forEach(el => el.innerText = n.a);
        document.querySelectorAll('.label-b, .opt-b').forEach(el => el.innerText = n.b);
        document.querySelector('.ph-a').placeholder = `${n.a} ì˜ˆì‚°`;
        document.querySelector('.ph-b').placeholder = `${n.b} ì˜ˆì‚°`;

        document.getElementById('fixedPrep').innerHTML = PRESET_PREP.map(x=>`<label class="check-item"><input type="checkbox"><div class="check-text">${x}</div></label>`).join('');
        document.getElementById('customPrepList').innerHTML = s.customPrep.map(x=>`<div style="font-size:13px; padding:8px 0; border-bottom:1px solid #ccc; display:flex; justify-content:space-between;"><span>â€¢ ${x.text}</span> <button onclick="delItem('prep','${x.id}')" class="btn-del">Ã—</button></div>`).join('');
        document.getElementById('planList').innerHTML = s.plan.sort((a,b)=>a.day-b.day || a.time.localeCompare(b.time)).map(p=>`<div class="card"><div class="card-inner"><small>DAY ${p.day} | ${p.time}</small><br><b>${p.title}</b><p style="font-size:12px;">${p.memo}</p><button onclick="delItem('plan','${p.id}')" class="btn-del">Ã—</button></div></div>`).join('');
        
        let sp = {p:0, a:0, b:0}; s.pay.forEach(e => sp[e.target] += e.amt);
        document.getElementById('b-p').innerText = `Â¥${(s.buds.p - sp.p).toLocaleString()}`;
        document.getElementById('b-a').innerText = `Â¥${(s.buds.a - sp.a).toLocaleString()}`;
        document.getElementById('b-b').innerText = `Â¥${(s.buds.b - sp.b).toLocaleString()}`;
        
        document.getElementById('payList').innerHTML = s.pay.sort((a,b)=>b.createdAt-a.createdAt).map(e=>`<div class="card"><div class="card-inner"><b>[${e.target==='p'?'ê³µê¸ˆ':n[e.target]}] ${e.name}</b><br><span>Â¥${e.amt.toLocaleString()}</span><div class="img-scroll">${(e.imgs||[]).map(m=>`<img src="${m}">`).join('')}</div><button onclick="delItem('pay','${e.id}')" class="btn-del">Ã—</button></div></div>`).join('');
        document.getElementById('diaryList').innerHTML = s.diary.sort((a,b)=>b.createdAt-a.createdAt).map(d=>`<div class="card"><div class="card-inner"><small>DAY ${d.day} | ${d.user}</small><p>${d.text}</p><div class="img-scroll">${(d.imgs||[]).map(m=>`<img src="${m}">`).join('')}</div><div>${(d.comments||[]).map(c=>`<div style="font-size:11px;">ğŸ’¬ ${c}</div>`).join('')}<div style="display:flex; gap:5px;"><input type="text" id="cmt-in-${d.id}" placeholder="ëŒ“ê¸€" style="margin:0; padding:5px;"><button onclick="addComment('${d.id}')">OK</button></div></div><button onclick="delItem('diary','${d.id}')" class="btn-del">Ã—</button></div></div>`).join('');
        document.getElementById('principlesUI').innerHTML = DRIVE_P.map(p=>`<div style="margin-bottom:10px;"><span>${p.e}</span> <b>${p.b}</b><br><small>${p.s}</small></div>`).join('');
        document.getElementById('presetList').innerHTML = PRESET_PLACES.map(p => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${p.n}</b> <button onclick="window.setPresetToInput('${p.n}','${p.m}')">ADD</button></div>`).join('');
    }
    window.setPresetToInput = (n, m) => { document.getElementById('planTitle').value = n; document.getElementById('planMemo').value = m; };
</script>
</body>
</html>